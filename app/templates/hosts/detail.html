{% extends "base.html" %}
{% block title %}{{ host.hostname }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1>{{ host.hostname }}</h1>
        <p style="color: var(--gray-600);">{{ host.ip_address or 'No IP specified' }}</p>
    </div>
    <div class="actions">
        <form action="{{ url_for('main.scan_host', host_id=host.id) }}" method="POST" style="display: inline;">
            <button type="submit" class="btn btn-success">Health Scan</button>
        </form>
        <a href="{{ url_for('main.av_scan_host', host_id=host.id) }}" class="btn btn-primary">AV Scan</a>
        <a href="{{ url_for('main.edit_host', host_id=host.id) }}" class="btn btn-secondary">Edit</a>
        <form action="{{ url_for('main.delete_host', host_id=host.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this host?');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</div>

<div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
    <div class="stat-card">
        <div class="stat-label">Status</div>
        <div style="margin-top: 0.5rem;">
            <span class="badge badge-{{ host.status }}" style="font-size: 1rem;">{{ host.status }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">OS Type</div>
        <div style="margin-top: 0.5rem;">
            <span class="badge badge-{{ host.os_type }}" style="font-size: 1rem;">{{ host.os_type }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Last Scan</div>
        <div class="stat-value" style="font-size: 1rem;">
            {% if host.last_scan %}
                {{ host.last_scan.strftime('%Y-%m-%d %H:%M') }}
            {% else %}
                Never
            {% endif %}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Port</div>
        <div class="stat-value" style="font-size: 1rem;">
            {% if host.os_type == 'linux' %}
                SSH: {{ host.ssh_port }}
            {% else %}
                WinRM: {{ host.winrm_port }}
            {% endif %}
        </div>
    </div>
</div>

{% if latest_scan %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Latest Scan Results</h2>
        <span style="color: var(--gray-600); font-size: 0.875rem;">
            {{ latest_scan.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
        </span>
    </div>

    {% if latest_scan.success %}
    <div class="metric-grid">
        {% if latest_scan.cpu_usage is not none %}
        <div class="metric-card">
            <div class="metric-title">CPU Usage</div>
            <div class="metric-value">{{ "%.1f"|format(latest_scan.cpu_usage) }}%</div>
            <div class="progress-bar">
                <div class="progress-fill {% if latest_scan.cpu_usage < 50 %}low{% elif latest_scan.cpu_usage < 80 %}medium{% else %}high{% endif %}"
                     style="width: {{ latest_scan.cpu_usage }}%"></div>
            </div>
        </div>
        {% endif %}

        {% if latest_scan.memory_percent is not none %}
        <div class="metric-card">
            <div class="metric-title">Memory Usage</div>
            <div class="metric-value">{{ "%.1f"|format(latest_scan.memory_percent) }}%</div>
            <div class="progress-bar">
                <div class="progress-fill {% if latest_scan.memory_percent < 50 %}low{% elif latest_scan.memory_percent < 80 %}medium{% else %}high{% endif %}"
                     style="width: {{ latest_scan.memory_percent }}%"></div>
            </div>
            {% if latest_scan.memory_total %}
            <small style="color: var(--gray-600);">
                {{ (latest_scan.memory_used / 1073741824)|round(1) }} GB / {{ (latest_scan.memory_total / 1073741824)|round(1) }} GB
            </small>
            {% endif %}
        </div>
        {% endif %}

        {% if latest_scan.process_count %}
        <div class="metric-card">
            <div class="metric-title">Running Processes</div>
            <div class="metric-value">{{ latest_scan.process_count }}</div>
        </div>
        {% endif %}

        {% if latest_scan.uptime %}
        <div class="metric-card">
            <div class="metric-title">Uptime</div>
            <div class="metric-value" style="font-size: 1rem;">{{ latest_scan.uptime }}</div>
        </div>
        {% endif %}
    </div>

    <div style="margin-top: 1.5rem;">
        {% if latest_scan.os_info %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">OS Information</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.os_info }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.logged_users %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Logged In Users</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.logged_users or 'No users logged in' }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.disk_info %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Disk Usage</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.disk_info }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.running_processes %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Running Processes (Top 50)</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.running_processes }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.network_info %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Network Information</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.network_info }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.recent_logs %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Recent Logs</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.recent_logs }}</pre>
        </details>
        {% endif %}
    </div>

    <!-- Event Analysis Section -->
    {% if latest_scan.event_summary %}
    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
        <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">üìä Event Analysis</h3>

        {% if latest_scan.event_summary %}
        <div class="metric-card" style="background: var(--gray-50); margin-bottom: 1rem;">
            <div class="metric-title">Event Summary</div>
            <pre style="margin-top: 0.5rem; background: transparent; padding: 0; font-size: 0.9rem;">{{ latest_scan.event_summary }}</pre>
        </div>
        {% endif %}

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
            {% if latest_scan.security_events and latest_scan.security_events != 'No security events found' %}
            <details style="background: var(--gray-50); border-radius: 8px; padding: 1rem;">
                <summary style="cursor: pointer; font-weight: 600; color: var(--gray-700);">
                    üîê Security Events
                    <span style="font-weight: normal; color: var(--gray-500); font-size: 0.875rem;">(24h)</span>
                </summary>
                <pre style="margin-top: 0.75rem; font-size: 0.8rem; max-height: 250px;">{{ latest_scan.security_events }}</pre>
            </details>
            {% endif %}

            {% if latest_scan.system_events and latest_scan.system_events != 'No system events found' %}
            <details style="background: var(--gray-50); border-radius: 8px; padding: 1rem;">
                <summary style="cursor: pointer; font-weight: 600; color: var(--gray-700);">
                    ‚öôÔ∏è System Events
                    <span style="font-weight: normal; color: var(--gray-500); font-size: 0.875rem;">(7d)</span>
                </summary>
                <pre style="margin-top: 0.75rem; font-size: 0.8rem; max-height: 250px;">{{ latest_scan.system_events }}</pre>
            </details>
            {% endif %}

            {% if latest_scan.application_events and latest_scan.application_events != 'No application events found' %}
            <details style="background: var(--gray-50); border-radius: 8px; padding: 1rem;">
                <summary style="cursor: pointer; font-weight: 600; color: var(--gray-700);">
                    üì± Application Events
                    <span style="font-weight: normal; color: var(--gray-500); font-size: 0.875rem;">(24h)</span>
                </summary>
                <pre style="margin-top: 0.75rem; font-size: 0.8rem; max-height: 250px;">{{ latest_scan.application_events }}</pre>
            </details>
            {% endif %}

            {% if latest_scan.hardware_events and latest_scan.hardware_events != 'No hardware events found' %}
            <details style="background: var(--gray-50); border-radius: 8px; padding: 1rem;">
                <summary style="cursor: pointer; font-weight: 600; color: var(--gray-700);">
                    üîß Hardware Events
                    <span style="font-weight: normal; color: var(--gray-500); font-size: 0.875rem;">(7d)</span>
                </summary>
                <pre style="margin-top: 0.75rem; font-size: 0.8rem; max-height: 250px;">{{ latest_scan.hardware_events }}</pre>
            </details>
            {% endif %}

            {% if latest_scan.critical_errors and latest_scan.critical_errors != 'No critical errors found' %}
            <details style="background: #fef2f2; border-radius: 8px; padding: 1rem;">
                <summary style="cursor: pointer; font-weight: 600; color: #991b1b;">
                    üö® Critical Errors
                    <span style="font-weight: normal; color: #991b1b; font-size: 0.875rem;">(7d)</span>
                </summary>
                <pre style="margin-top: 0.75rem; font-size: 0.8rem; max-height: 250px;">{{ latest_scan.critical_errors }}</pre>
            </details>
            {% endif %}

            {% if latest_scan.recent_changes and latest_scan.recent_changes != 'No recent changes found' %}
            <details style="background: var(--gray-50); border-radius: 8px; padding: 1rem;">
                <summary style="cursor: pointer; font-weight: 600; color: var(--gray-700);">
                    üì¶ Recent Changes
                    <span style="font-weight: normal; color: var(--gray-500); font-size: 0.875rem;">(installs/updates)</span>
                </summary>
                <pre style="margin-top: 0.75rem; font-size: 0.8rem; max-height: 250px;">{{ latest_scan.recent_changes }}</pre>
            </details>
            {% endif %}

            {% if latest_scan.cbs_logs and latest_scan.cbs_logs != 'CBS logs not available' and latest_scan.cbs_logs != 'CBS log not accessible' %}
            <details style="background: var(--gray-50); border-radius: 8px; padding: 1rem;">
                <summary style="cursor: pointer; font-weight: 600; color: var(--gray-700);">
                    ü™ü CBS Logs
                    <span style="font-weight: normal; color: var(--gray-500); font-size: 0.875rem;">(Windows)</span>
                </summary>
                <pre style="margin-top: 0.75rem; font-size: 0.8rem; max-height: 250px;">{{ latest_scan.cbs_logs }}</pre>
            </details>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="alert alert-error">
        <strong>Scan Failed:</strong> {{ latest_scan.error_message }}
    </div>
    {% endif %}
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <h3>No scan data yet</h3>
        <p>Run a scan to see system health metrics.</p>
        <form action="{{ url_for('main.scan_host', host_id=host.id) }}" method="POST" style="margin-top: 1rem;">
            <button type="submit" class="btn btn-success">Run First Scan</button>
        </form>
    </div>
</div>
{% endif %}

{% if scan_history and scan_history|length > 1 %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Health Scan History</h2>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Status</th>
                <th>CPU</th>
                <th>Memory</th>
                <th>Processes</th>
            </tr>
        </thead>
        <tbody>
            {% for scan in scan_history %}
            <tr>
                <td>{{ scan.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>
                    {% if scan.success %}
                        <span class="badge badge-online">Success</span>
                    {% else %}
                        <span class="badge badge-error">Failed</span>
                    {% endif %}
                </td>
                <td>{{ "%.1f"|format(scan.cpu_usage) if scan.cpu_usage else '-' }}%</td>
                <td>{{ "%.1f"|format(scan.memory_percent) if scan.memory_percent else '-' }}%</td>
                <td>{{ scan.process_count or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- AV Scan Section -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Antivirus Scanning</h2>
        <a href="{{ url_for('main.av_scan_host', host_id=host.id) }}" class="btn btn-primary btn-sm">Run AV Scan</a>
    </div>

    {% if latest_av_scan %}
    <div style="margin-bottom: 1rem;">
        <h3 style="font-size: 1rem; color: var(--gray-700); margin-bottom: 0.75rem;">Latest AV Scan</h3>
        <div class="metric-grid" style="grid-template-columns: repeat(4, 1fr);">
            <div class="metric-card">
                <div class="metric-title">Status</div>
                {% if latest_av_scan.success %}
                    {% if latest_av_scan.threats_found > 0 %}
                        <span class="badge badge-error">Threats Found</span>
                    {% else %}
                        <span class="badge badge-online">Clean</span>
                    {% endif %}
                {% else %}
                    <span class="badge badge-error">Failed</span>
                {% endif %}
            </div>
            <div class="metric-card">
                <div class="metric-title">Scan Type</div>
                <div style="text-transform: capitalize;">{{ latest_av_scan.scan_type }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Files Scanned</div>
                <div class="metric-value" style="font-size: 1.25rem;">{{ latest_av_scan.files_scanned or 0 }}</div>
            </div>
            <div class="metric-card {% if latest_av_scan.threats_found > 0 %}error{% endif %}">
                <div class="metric-title">Threats</div>
                <div class="metric-value" style="font-size: 1.25rem;">{{ latest_av_scan.threats_found or 0 }}</div>
            </div>
        </div>

        {% if latest_av_scan.threats_found > 0 %}
        <div class="alert alert-error" style="margin-top: 1rem;">
            <strong>Warning:</strong> Threats detected!
            <a href="{{ url_for('main.av_scan_detail', host_id=host.id, scan_id=latest_av_scan.id) }}" style="color: inherit; text-decoration: underline;">View details</a>
        </div>
        {% endif %}

        <p style="margin-top: 0.75rem; color: var(--gray-600); font-size: 0.875rem;">
            Scanned {{ latest_av_scan.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
            <a href="{{ url_for('main.av_scan_detail', host_id=host.id, scan_id=latest_av_scan.id) }}" style="margin-left: 1rem;">View full report</a>
        </p>
    </div>

    {% if av_scan_history and av_scan_history|length > 1 %}
    <h3 style="font-size: 1rem; color: var(--gray-700); margin: 1rem 0 0.75rem;">AV Scan History</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Type</th>
                <th>Status</th>
                <th>Files</th>
                <th>Threats</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for av_scan in av_scan_history %}
            <tr>
                <td>{{ av_scan.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td style="text-transform: capitalize;">{{ av_scan.scan_type }}</td>
                <td>
                    {% if av_scan.success %}
                        {% if av_scan.threats_found > 0 %}
                            <span class="badge badge-error">Threats</span>
                        {% else %}
                            <span class="badge badge-online">Clean</span>
                        {% endif %}
                    {% else %}
                        <span class="badge badge-error">Failed</span>
                    {% endif %}
                </td>
                <td>{{ av_scan.files_scanned or 0 }}</td>
                <td>{{ av_scan.threats_found or 0 }}</td>
                <td>
                    <a href="{{ url_for('main.av_scan_detail', host_id=host.id, scan_id=av_scan.id) }}" class="btn btn-secondary btn-sm">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% else %}
    <div class="empty-state" style="padding: 2rem;">
        <h3>No AV scans yet</h3>
        <p>Run an antivirus scan to check for malware on this host.</p>
        <a href="{{ url_for('main.av_scan_host', host_id=host.id) }}" class="btn btn-primary" style="margin-top: 1rem;">Run First AV Scan</a>
    </div>
    {% endif %}
</div>
{% endblock %}
