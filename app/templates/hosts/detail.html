{% extends "base.html" %}
{% block title %}{{ host.hostname }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1>{{ host.hostname }}</h1>
        <p style="color: var(--gray-600);">{{ host.ip_address or 'No IP specified' }}</p>
    </div>
    <div class="actions">
        <form action="{{ url_for('main.scan_host', host_id=host.id) }}" method="POST" style="display: inline;">
            <button type="submit" class="btn btn-success">Run Scan</button>
        </form>
        <a href="{{ url_for('main.edit_host', host_id=host.id) }}" class="btn btn-secondary">Edit</a>
        <form action="{{ url_for('main.delete_host', host_id=host.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this host?');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</div>

<div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
    <div class="stat-card">
        <div class="stat-label">Status</div>
        <div style="margin-top: 0.5rem;">
            <span class="badge badge-{{ host.status }}" style="font-size: 1rem;">{{ host.status }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">OS Type</div>
        <div style="margin-top: 0.5rem;">
            <span class="badge badge-{{ host.os_type }}" style="font-size: 1rem;">{{ host.os_type }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Last Scan</div>
        <div class="stat-value" style="font-size: 1rem;">
            {% if host.last_scan %}
                {{ host.last_scan.strftime('%Y-%m-%d %H:%M') }}
            {% else %}
                Never
            {% endif %}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Port</div>
        <div class="stat-value" style="font-size: 1rem;">
            {% if host.os_type == 'linux' %}
                SSH: {{ host.ssh_port }}
            {% else %}
                WinRM: {{ host.winrm_port }}
            {% endif %}
        </div>
    </div>
</div>

{% if latest_scan %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Latest Scan Results</h2>
        <span style="color: var(--gray-600); font-size: 0.875rem;">
            {{ latest_scan.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
        </span>
    </div>

    {% if latest_scan.success %}
    <div class="metric-grid">
        {% if latest_scan.cpu_usage is not none %}
        <div class="metric-card">
            <div class="metric-title">CPU Usage</div>
            <div class="metric-value">{{ "%.1f"|format(latest_scan.cpu_usage) }}%</div>
            <div class="progress-bar">
                <div class="progress-fill {% if latest_scan.cpu_usage < 50 %}low{% elif latest_scan.cpu_usage < 80 %}medium{% else %}high{% endif %}"
                     style="width: {{ latest_scan.cpu_usage }}%"></div>
            </div>
        </div>
        {% endif %}

        {% if latest_scan.memory_percent is not none %}
        <div class="metric-card">
            <div class="metric-title">Memory Usage</div>
            <div class="metric-value">{{ "%.1f"|format(latest_scan.memory_percent) }}%</div>
            <div class="progress-bar">
                <div class="progress-fill {% if latest_scan.memory_percent < 50 %}low{% elif latest_scan.memory_percent < 80 %}medium{% else %}high{% endif %}"
                     style="width: {{ latest_scan.memory_percent }}%"></div>
            </div>
            {% if latest_scan.memory_total %}
            <small style="color: var(--gray-600);">
                {{ (latest_scan.memory_used / 1073741824)|round(1) }} GB / {{ (latest_scan.memory_total / 1073741824)|round(1) }} GB
            </small>
            {% endif %}
        </div>
        {% endif %}

        {% if latest_scan.process_count %}
        <div class="metric-card">
            <div class="metric-title">Running Processes</div>
            <div class="metric-value">{{ latest_scan.process_count }}</div>
        </div>
        {% endif %}

        {% if latest_scan.uptime %}
        <div class="metric-card">
            <div class="metric-title">Uptime</div>
            <div class="metric-value" style="font-size: 1rem;">{{ latest_scan.uptime }}</div>
        </div>
        {% endif %}
    </div>

    <div style="margin-top: 1.5rem;">
        {% if latest_scan.os_info %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">OS Information</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.os_info }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.logged_users %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Logged In Users</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.logged_users or 'No users logged in' }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.disk_info %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Disk Usage</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.disk_info }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.running_processes %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Running Processes (Top 50)</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.running_processes }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.network_info %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Network Information</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.network_info }}</pre>
        </details>
        {% endif %}

        {% if latest_scan.recent_logs %}
        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">Recent Logs</summary>
            <pre style="margin-top: 0.5rem;">{{ latest_scan.recent_logs }}</pre>
        </details>
        {% endif %}
    </div>

    {% else %}
    <div class="alert alert-error">
        <strong>Scan Failed:</strong> {{ latest_scan.error_message }}
    </div>
    {% endif %}
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <h3>No scan data yet</h3>
        <p>Run a scan to see system health metrics.</p>
        <form action="{{ url_for('main.scan_host', host_id=host.id) }}" method="POST" style="margin-top: 1rem;">
            <button type="submit" class="btn btn-success">Run First Scan</button>
        </form>
    </div>
</div>
{% endif %}

{% if scan_history and scan_history|length > 1 %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Scan History</h2>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Status</th>
                <th>CPU</th>
                <th>Memory</th>
                <th>Processes</th>
            </tr>
        </thead>
        <tbody>
            {% for scan in scan_history %}
            <tr>
                <td>{{ scan.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>
                    {% if scan.success %}
                        <span class="badge badge-online">Success</span>
                    {% else %}
                        <span class="badge badge-error">Failed</span>
                    {% endif %}
                </td>
                <td>{{ "%.1f"|format(scan.cpu_usage) if scan.cpu_usage else '-' }}%</td>
                <td>{{ "%.1f"|format(scan.memory_percent) if scan.memory_percent else '-' }}%</td>
                <td>{{ scan.process_count or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
